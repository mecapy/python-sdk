version: '3'

# Taskfile for go-task (https://taskfile.dev)
# Provides common developer workflows for this Python SDK project.

vars:
  SDK_MODULE: mecapy

# Load environment from local files when present
dotenv: [ "dev/env.local" ]

tasks:
  default:
    desc: "Show available tasks"
    cmds:
      - task --list

  check:
    desc: "Run all quality checks (lint with ruff, typecheck with mypy)"
    deps: [ install ]
    cmds:
      - uv run mypy {{.SDK_MODULE}}
      - uv run ruff check .

  format:
    desc: "Format code with ruff and fix check"
    deps: [ install ]
    cmds:
      - uv run ruff format .
      - uv run ruff check --fix .

  install:
    desc: "Install project dependencies (uses uv if available, falls back to pip)"
    cmds:
      - |
        if command -v uv >/dev/null 2>&1; then
          echo "Using uv to sync dependencies..."
          uv sync --group dev
        else
          echo "uv not found, using pip (editable + dev extras)..."
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
        fi

  test:
    desc: "Run all batch tests"
    deps: [ install, test:unit ]


  test:unit:
    desc: "Run unit tests only"
    deps: [ install ]
    cmds:
      - uv run pytest -m unit

  test:interactive:
    desc: "Run interactive tests only"
    deps: [ install ]
    cmds:
      - uv run pytest -m interactive

  test:not_production:
    desc: "Run all tests except production"
    deps: [ install ]
    cmds:
      - uv run pytest -m "not production"

  build:
    desc: "Build wheel and sdist using hatchling (via uv if available)"
    deps: [ install ]
    cmds:
      - uv build

  clean:
    desc: "Clean build, cache and test artifacts"
    cmds:
      - rm -rf dist build *.egg-info .mypy_cache .ruff_cache .pytest_cache .coverage coverage_html htmlcov coverage.xml

  # Pre-commit hooks
  precommit:install:
    desc: "Install pre-commit hooks"
    deps: [ install ]
    cmds:
      - uv run pre-commit install

  precommit:run:
    desc: "Run pre-commit hooks on all files"
    deps: [ install ]
    cmds:
      - uv run pre-commit run --all-files

  # Package publication helpers
  publish:test:
    desc: "Publish package to TestPyPI"
    deps: [ build ]
    cmds:
      - uv run twine upload --repository testpypi dist/*

  publish:prod:
    desc: "Publish package to PyPI (production)"
    deps: [ build ]
    cmds:
      - uv run twine upload dist/*

  # Environment initialization
  init:
    desc: "Initialize development environment with uv and Python"
    cmds:
      - |
        echo "ğŸš€ Initializing development environment..."
        if ! command -v uv >/dev/null 2>&1; then
          echo "Installing uv..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
        fi
        echo "Using Python version from .python-version file..."
        uv python install $(cat .python-version)
        echo "Creating virtual environment..."
        uv venv --python $(cat .python-version)
        echo "Installing dependencies..."
        uv sync --group dev
        echo "âœ… Environment initialized successfully!"

  # Version management
  version:
    desc: "Show current version information"
    cmds:
      - |
        echo "ğŸ“¦ Version Information:"
        echo "===================="

        # Check git status
        if ! git diff-index --quiet HEAD -- 2>/dev/null; then
          echo "âš ï¸  Working directory has uncommitted changes"
          GIT_STATUS="dirty"
        else
          echo "âœ… Working directory is clean"
          GIT_STATUS="clean"
        fi
        echo ""

        # Get git tag version
        if git describe --tags --abbrev=0 >/dev/null 2>&1; then
          LATEST_TAG=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "ğŸ·ï¸  Latest git tag: $LATEST_TAG"

          # Show git describe for more context
          GIT_DESCRIBE=$(git describe --tags --dirty 2>/dev/null || echo "unknown")
          echo "ğŸ“‹ Git describe: $GIT_DESCRIBE"
        else
          echo "ğŸ·ï¸  Latest git tag: No tags found"
        fi

        # Get installed package version
        echo -n "ğŸ“¦ Installed package: "
        INSTALLED_VERSION=$(uv run python -c "
        try:
            import importlib.metadata
            print(importlib.metadata.version('{{.SDK_MODULE}}-sdk'))
        except Exception as e:
            print('Not installed or error:', str(e))
        " 2>/dev/null)
        echo "$INSTALLED_VERSION"

        # Explain version behavior
        if [ "$GIT_STATUS" = "dirty" ]; then
          echo ""
          echo "ğŸ’¡ Note: Installed package shows dev version because working directory has uncommitted changes."
          echo "   To get tag version, commit changes and run 'task version:sync'"
        fi

        # Get build version (if dist exists)
        if [ -d "dist" ] && [ "$(ls -A dist 2>/dev/null)" ]; then
          BUILT_VERSION=$(ls dist/*.whl 2>/dev/null | head -1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          if [ -n "$BUILT_VERSION" ]; then
            echo "ğŸ”¨ Last built: $BUILT_VERSION"
          fi
        fi

  version:sync:
    desc: "Synchronize installed package with git tag version (requires clean working directory)"
    deps: [ install ]
    cmds:
      - |
        echo "ğŸ”„ Synchronizing package version with git tags..."
        if ! git diff-index --quiet HEAD -- 2>/dev/null; then
          echo "âš ï¸  Warning: Working directory has uncommitted changes."
          echo "   The installed package will still show dev version until changes are committed."
        fi
        echo "ğŸ—‘ï¸  Uninstalling current package..."
        uv pip uninstall mecapy-sdk --quiet || true
        echo "ğŸ”„ Reinstalling with fresh version calculation..."
        uv sync --group dev
        echo "âœ… Package version synchronized!"

  version:status:
    desc: "Show git status and version info"
    cmds:
      - |
        echo "ğŸ“‹ Git Status:"
        echo "=============="
        git status --short
        echo ""
        if ! git diff-index --quiet HEAD -- 2>/dev/null; then
          echo "ğŸ’¡ Tip: Commit changes to get clean tag version: 'git add . && git commit -m \"Update files\"'"
        else
          echo "âœ… Working directory is clean - package version will match git tag"
        fi

  version:set:
    desc: "Set version tag (usage: task version:set VERSION=1.0.0)"
    vars:
      VERSION: '{{.VERSION}}'
    cmds:
      - |
        if [ -z "{{.VERSION}}" ]; then
          echo "âŒ Please provide VERSION: task version:set VERSION=0.1.0"
          exit 1
        fi
        echo "ğŸ·ï¸  Setting version {{.VERSION}}..."
        git tag -a "v{{.VERSION}}" -m "Release version {{.VERSION}}"
        echo "âœ… Version {{.VERSION}} tagged successfully!"
        echo "ğŸ“Œ Don't forget to push the tag: git push origin v{{.VERSION}}"
        echo "ğŸ’¡ Tip: Run 'task version:sync' to update the installed package version"

  # Lock file management
  lock:
    desc: "Update lock file after dependency changes"
    cmds:
      - uv lock
      - echo "âš ï¸  Don't forget to commit uv.lock with your changes!"
